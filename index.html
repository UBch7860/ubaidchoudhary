<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ubaid Kirana Store</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<style>
/* --- MODERN CSS RESET & VARIABLES (PREMIUM UI) --- */
:root {
    --primary-color: #008060;
    --primary-dark: #004c3f;
    --primary-light: #e0f2f1;
    --accent-color: #ff6f00;  
    --bg-color: #f8f9fa;
    --text-dark: #1a1a1a;
    --text-grey: #666;
    --card-bg: #ffffff;
    --shadow-soft: 0 8px 24px rgba(0,0,0,0.08);
    --border-radius: 16px;
    --bottom-nav-height: 65px;
    --font-main: 'Poppins', sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg-color); color: var(--text-dark); padding-bottom: 85px; font-family: var(--font-main); -webkit-font-smoothing: antialiased; }

/* --- ANIMATIONS --- */
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.container, .form-card, .product-item { animation: fadeIn 0.3s ease-out; }

/* --- HEADER --- */
.header {
    background: rgba(0, 128, 96, 0.95);
    backdrop-filter: blur(10px);
    color: #fff; height: 75px; display: flex; align-items: center;
    padding: 0 15px; position: sticky; top: 0; z-index: 999;
    box-shadow: 0 4px 20px rgba(0,128,96,0.3);
}
.logo { font-weight: 700; color: #fff; font-size: 1.4rem; letter-spacing: 0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.search-bar {
    flex: 1; margin-left: 15px; background: rgba(255,255,255,0.15); border-radius: 50px; 
    overflow: hidden; display: flex; align-items: center; height: 42px; border: 1px solid rgba(255,255,255,0.2);
    transition: 0.3s;
}
.search-bar:focus-within { background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.search-bar input {
    width: 100%; border: none; padding: 0 15px; outline: none; font-size: 14px; 
    background: transparent; height: 100%; color: #fff; font-family: var(--font-main);
}
.search-bar:focus-within input { color: #333; }
.search-bar input::placeholder { color: rgba(255,255,255,0.8); }
.search-bar:focus-within input::placeholder { color: #999; }

/* --- NAVIGATION --- */
.bottom-nav {
    position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
    display: flex; justify-content: space-around; align-items: center;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid rgba(0,0,0,0.05);
    border-radius: 20px 20px 0 0;
}
.nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    font-size: 11px; color: #999; width: 25%; height: 100%; cursor: pointer; transition: 0.3s;
    font-weight: 500;
}
.nav-item.active { color: var(--primary-color); }
.nav-item span { font-size: 22px; margin-bottom: 4px; }
#cartCountBadge {
    background: var(--accent-color); color: white; font-size: 10px; font-weight: 700;
    padding: 2px 6px; border-radius: 10px; position: absolute; top: -8px; right: -10px;
    border: 2px solid #fff; box-shadow: 0 2px 5px rgba(255,111,0,0.3);
}
.nav-cart-badge { position: relative; }

/* --- MENU --- */
.menu-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 1001; backdrop-filter: blur(2px);
}
.menu-drawer {
    position: absolute; bottom: -100%; left: 0; width: 100%;
    background: #fff; border-radius: 25px 25px 0 0;
    padding: 30px 20px; transition: bottom 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.menu-open .menu-drawer { bottom: 0; }
.menu-open { display: block; }
.menu-item {
    display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid #f5f5f5;
    color: #333; font-size: 16px; font-weight: 500; cursor: pointer; transition: 0.2s;
}
.menu-item:active { background: #f9f9f9; transform: scale(0.98); }
.menu-icon { margin-right: 15px; font-size: 20px; width: 30px; text-align: center; }

/* --- PRODUCTS GRID --- */
.container { max-width: 900px; margin: auto; padding: 15px; }
h3 { font-weight: 600; font-size: 18px; color: #333; letter-spacing: -0.5px; }
#productGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.product-item {
    background: #fff; padding: 12px; border-radius: var(--border-radius);
    box-shadow: var(--shadow-soft); display: flex; flex-direction: column;
    border: none; position: relative; transition: transform 0.2s;
    overflow: hidden; will-change: transform;
}
.product-item:active { transform: scale(0.98); }
.product-img { 
    width: 100%; height: 140px; object-fit: contain; margin-bottom: 10px; 
    display: block; margin-left: auto; margin-right: auto; cursor: pointer;
}
.product-details b { 
    display: block; margin-bottom: 6px; color: #212121; font-size: 14px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600;
}
.product-desc-text {
    font-size: 11px; color: #878787; margin-bottom: 8px; line-height: 1.4;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    overflow: hidden; text-overflow: ellipsis;
}
.product-details div.price-tag { 
    color: #212121; font-weight: 700; font-size: 16px; margin-bottom: 8px; 
}
.admin-edit-btn {
    position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff;
    border: none; border-radius: 5px; padding: 4px 8px; font-size: 10px; cursor: pointer; z-index: 10;
}

/* --- BUTTONS --- */
.btn-group { display: flex; gap: 8px; flex-direction: column; margin-top: auto; }
.add-btn {
    background: transparent; color: var(--primary-color); border: 2px solid var(--primary-color);
    padding: 8px 0; border-radius: 10px; cursor: pointer; font-weight: 600; width: 100%; 
    font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; transition: 0.2s;
}
.add-btn:active { background: var(--primary-light); }
.buy-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: #fff; border: none; padding: 10px 0; border-radius: 10px; cursor: pointer; 
    font-weight: 600; width: 100%; box-shadow: 0 4px 10px rgba(0,128,96,0.3);
    font-size: 13px; transition: 0.2s;
}
.buy-btn:active { transform: translateY(2px); box-shadow: 0 2px 5px rgba(0,128,96,0.2); }

/* --- PRODUCT DETAILS PAGE --- */
#productDetailsPage {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 2000; overflow-y: auto; display: none; padding-bottom: 90px;
}
#productDetailsPage.active { display: block; animation: fadeIn 0.3s ease-in-out; }
.pd-header {
    position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
    padding: 15px; display: flex; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); 
    z-index: 2001; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}
.pd-back { font-size: 24px; margin-right: 15px; color: #333; cursor: pointer; background: #f5f5f5; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
.pd-title-top { font-size: 18px; font-weight: 600; color: #333; }
.pd-scroll-content { padding: 20px; }
.pd-image-box {
    width: 100%; height: 280px; display: flex; align-items: center; justify-content: center;
    border: none; margin-bottom: 25px; border-radius: 20px; background: #fff; padding: 10px;
}
.pd-image { max-width: 100%; max-height: 100%; object-fit: contain; }
.pd-main-title { font-size: 22px; font-weight: 700; color: #212121; margin-bottom: 8px; line-height: 1.3; }
.pd-price { font-size: 32px; font-weight: 700; color: #212121; margin: 15px 0; letter-spacing: -1px; }
.pd-footer-actions {
    position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
    background: #fff; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    display: flex; align-items: center; padding: 0 20px; gap: 15px; z-index: 2002;
    border-radius: 20px 20px 0 0;
}

/* --- RATINGS --- */
.rating-row { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
.rating-badge { background-color: #388e3c; color: white; font-size: 12px; font-weight: 700; padding: 4px 8px; border-radius: 4px; }

/* --- QUANTITY & CONTROLS --- */
.qty-btn-group {
    display: flex; align-items: center; background: #fff; border-radius: 10px;
    width: 100%; justify-content: space-between; border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden;
}
.qty-btn-group span { padding: 10px 18px; cursor: pointer; font-weight: bold; color: var(--primary-color); font-size: 18px; background: #f9f9f9; }
.qty-btn-group .qty-val { flex-grow: 1; text-align: center; font-size: 16px; font-weight: 600; background: #fff; color: #333; }

/* --- FORMS & AUTH --- */
.form-card { background: #fff; padding: 30px 20px; border-radius: 20px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
.page-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.close-page-btn { background: #f5f5f5; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #333; font-weight: bold; }
input, textarea { 
    width: 100%; padding: 16px; margin: 10px 0; border: 1px solid #eaeaea; 
    border-radius: 12px; background: #fcfcfc; font-size: 15px; font-family: var(--font-main);
    transition: 0.3s;
}
input:focus, textarea:focus { border-color: var(--primary-color); background: #fff; box-shadow: 0 4px 12px rgba(0,128,96,0.1); outline: none; }
label { font-weight: 500; color: #555; }

/* --- CART & CHECKOUT --- */
.cart-row { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
.cart-item-img { width: 70px; height: 70px; object-fit: contain; border-radius: 10px; margin-right: 15px; background: #f9f9f9; padding: 5px; }
.cart-controls-mini { border-radius: 8px; border: 1px solid #eee; margin-top: 8px; }
.checkout-item { border-bottom: 1px dashed #eee; padding: 15px 0; }

/* --- AUTH PAGE --- */
#authPage { background: linear-gradient(135deg, #ffffff 0%, #f0f4f3 100%); }
.auth-input-group { text-align: left; width: 100%; margin-bottom: 15px; }
.auth-input-group label { margin-left: 5px; font-size: 13px; font-weight: 600; color: #444; }
.auth-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white; width: 100%; padding: 16px; border: none; border-radius: 12px; cursor: pointer; 
    font-size: 16px; margin-top: 25px; font-weight: 600; box-shadow: 0 8px 20px rgba(0,128,96,0.3);
}

/* --- OTHER --- */
.location-btn { background: #e3f2fd; color: #1565c0; border: 1px dashed #1565c0; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 14px; transition: 0.2s; }
.payment-tabs { background: #f5f5f5; border-radius: 12px; padding: 6px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
.tab-btn.active-tab { background: #fff; color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 10px; }
.pay-option { border: 1px solid #eee; border-radius: 12px; padding: 15px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.02); }
.time-slot-card { border-radius: 12px; padding: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); background: #fff; margin-bottom: 10px; }
.time-slot-card.selected-slot { border: 2px solid var(--primary-color); background: #e8f5e9; box-shadow: 0 4px 12px rgba(0,128,96,0.15); }

/* EDIT MODAL */
.modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
.modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 15px; animation: fadeIn 0.3s; }

/* Loading Spinner */
.loading-spinner {
    border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%;
    width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 30px auto;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="successOverlay" class="success-overlay hidden">
    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <h2 style="color: var(--primary-color); margin-top: 20px; font-weight:700;">Order Placed!</h2>
    <p style="color: #666;">Thank you for shopping with us.</p>
    <button class="buy-btn" style="width: 200px; margin-top: 30px;" onclick="closeSuccess()">Continue Shopping</button>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">‚úèÔ∏è Edit Product</h3>
        <span style="font-size:24px; cursor:pointer;" onclick="closeEditModal()">√ó</span>
    </div>
    <input type="hidden" id="editProdId">
    <label>Product Name</label>
    <input type="text" id="editProdName">
    <label>Price (‚Çπ)</label>
    <input type="number" id="editProdPrice">
    
    <label>Photo (Upload from Gallery or Paste URL)</label>
    <input type="file" id="editProdFile" accept="image/*" style="margin-bottom:10px;" onchange="handleImageUpload(this, 'editProdImg', 'editImgPreview')">
    <input type="text" id="editProdImg" placeholder="Image URL will appear here" onchange="previewEditImage()">
    
    <div style="text-align:center; margin:10px 0;">
        <img id="editImgPreview" src="" style="max-height:100px; border-radius:5px; border:1px solid #eee;">
    </div>
    <label>Description</label>
    <textarea id="editProdDesc" rows="2"></textarea>
    <button class="buy-btn" onclick="saveEditProduct()">Save Changes</button>
  </div>
</div>

<div id="authPage">
    <div style="width:100%; max-width:380px; text-align:center; padding: 20px;">
        <h1 style="color:var(--primary-color); margin-bottom:5px; font-size: 32px; letter-spacing: -1px;">Ubaid Store</h1>
        <p style="color:#888; font-size:15px; margin-bottom:40px; font-weight:300;">Premium Quality at your Doorstep</p>
        
        <div class="form-card" style="box-shadow: 0 10px 40px rgba(0,0,0,0.08);">
            <div class="auth-input-group">
                <label>Email Address</label>
                <input type="email" id="authEmail" placeholder="name@example.com" autocomplete="email">
            </div>
            <div class="auth-input-group">
                <label>Password</label>
                <input type="password" id="authPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            
            <button class="auth-btn" id="mainAuthBtn" onclick="handleLogin()">Login Securely</button>
            <p style="margin-top: 20px; font-size: 13px; color: #666; cursor:pointer;" onclick="resetPassword()">Forgot Password?</p>
        </div>

        <p style="margin-top: 25px; font-size: 15px; color: #666;"><span id="toggleText">New here? <b onclick="toggleAuthMode()" style="color:var(--primary-color); cursor:pointer;">Create Account</b></span></p>
        <div id="authError" style="color:#d32f2f; font-size:13px; margin-top:15px; font-weight:600;"></div>
    </div>
</div>

<div id="verifyPage" class="hidden">
    <div style="width:100%; max-width:400px; text-align:center; padding:30px;">
        <div style="font-size:60px; margin-bottom:20px;">üìß</div>
        <h2 style="color:#333; margin-bottom:10px;">Verify Email</h2>
        <p style="color:#666; margin:10px 0; line-height:1.6;">We sent a verification link to <br><strong><span id="userEmailDisplay" style="color:var(--primary-color);"></span></strong></p>
        <button class="auth-btn" style="background:#2e7d32; margin-top:30px;" onclick="checkVerification()">‚úÖ I Have Verified</button>
        <button style="background:none; border:none; color:#666; text-decoration:underline; margin-top:20px; cursor:pointer; font-size:14px;" onclick="resendVerificationLink()">Resend Link</button>
        <div style="margin-top:40px;"><span style="color:#d32f2f; cursor:pointer; font-size:14px; font-weight:600;" onclick="handleLogout()">Logout</span></div>
    </div>
</div>

<div id="appContainer" class="hidden">
    
    <div class="header">
        <div class="logo">Ubaid Store</div>
        <div class="search-bar">
            <span style="padding-left:15px; color:rgba(255,255,255,0.7)">üîç</span>
            <input id="searchInput" onkeyup="filter()" placeholder="Search products...">
        </div>
    </div>

    <div class="container" id="shopPage">
        <h3 style="margin:15px 0 20px 0;">All Products</h3>
        <div id="productGrid"></div>
        <div style="height:20px;"></div>
    </div>

    <div id="productDetailsPage">
        <div id="productDetailContent"></div>
    </div>

    <div class="container hidden" id="cartPage">
        <div class="form-card">
            <div class="page-title"><h3>üõí Your Cart</h3><span style="font-size:13px; color:#666; background:#f5f5f5; padding:4px 10px; border-radius:15px;">Items: <span id="cartCountInner">0</span></span></div>
            <div id="cartItems"></div>
            <div style="margin-top:25px; border-top:2px dashed #eee; padding-top:20px;">
                <h3 id="cartTotal" style="text-align:right; margin:0; color:var(--primary-color); font-size:22px;">Total: ‚Çπ0</h3>
            </div>
            <button class="buy-btn" style="margin-top:25px;" onclick="goToAddress('cart')">Proceed to Checkout</button>
        </div>
    </div>

    <div class="container hidden" id="addressPage">
        <div class="form-card">
            <div class="page-title"><h3>üìç Delivery Details</h3><span class="close-page-btn" onclick="goHome()">‚úï</span></div>
            <input type="text" id="custName" placeholder="Full Name">
            <input type="number" id="custPhone" placeholder="Mobile Number">
            <div class="location-btn" onclick="detectLocation()" id="locBtn"><span>üìç</span> Use Current Location (GPS)</div>
            <textarea id="custAddress" rows="3" placeholder="Full Address (House No, Area, City)"></textarea>
            <label style="display:flex; align-items:center; gap:10px; margin-top:10px; margin-bottom:20px; font-size:14px; color:#555; cursor:pointer; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="checkbox" id="saveAddrCheckbox" checked style="width:auto; margin:0;"> Save this address for future</label>
            <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">
            <div id="checkoutItemsList"></div>
            <div id="checkoutBillDetails" style="margin-top: 20px; background: #fff8e1; padding: 20px; border-radius: 12px; border: 1px solid #ffe0b2;"></div>
            <button class="buy-btn" style="margin-top:25px;" onclick="goToSlotPage()">Select Delivery Time</button>
        </div>
    </div>

    <div class="container hidden" id="slotPage">
        <div class="form-card">
            <div class="page-title"><h3>‚è∞ Select Time</h3><span class="close-page-btn" onclick="goBackToAddress()">‚úï</span></div>
            <p style="color:#666; font-size:14px; margin-bottom:15px;">When should we deliver your order?</p>
            <div id="slotsContainer" class="slot-container"></div>
            <button class="buy-btn" style="margin-top:25px;" onclick="goToPayment()">Continue to Payment</button>
        </div>
    </div>

    <div class="container hidden" id="paymentPage">
        <div class="form-card">
            <div class="page-title"><h3>üí≥ Payment</h3><span class="close-page-btn" onclick="goToSlotPage()">‚úï</span></div>
            <center><p style="color:#888; font-size:14px; margin-bottom:5px;">Total Amount</p><div class="total-pay-display" id="paymentTotalDisplay" style="color:var(--primary-color); font-size:32px; font-weight:700;">‚Çπ0</div></center>
            <div class="payment-tabs" style="margin-top:20px;">
                <div class="tab-btn active-tab" id="tabOnline" onclick="togglePaymentMode('online')">Pay Online</div>
                <div class="tab-btn" id="tabCOD" onclick="togglePaymentMode('cod')">Cash on Delivery</div>
            </div>
            <div id="onlineSection" style="margin-top:20px;">
                <p style="font-size:14px; font-weight:600; color:#333; margin-bottom:15px;">Select App:</p>
                <div class="payment-methods">
                    <div class="pay-option" onclick="startRazorpayPayment()"><img src="https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg" class="pay-logo"><span class="pay-label">Paytm</span></div>
                    <div class="pay-option" onclick="startRazorpayPayment()"><img src="https://upload.wikimedia.org/wikipedia/commons/7/71/PhonePe_Logo.svg" class="pay-logo"><span class="pay-label">PhonePe</span></div>
                    <div class="pay-option" onclick="startRazorpayPayment()"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg" class="pay-logo"><span class="pay-label">GPay</span></div>
                </div>
                <button class="buy-btn" style="margin-top:25px; background: #2874f0;" onclick="startRazorpayPayment()">Pay Now with Razorpay</button>
                <div style="margin-top: 15px; text-align: center; font-size: 11px; color: #999;">üîí 100% Secure Payments by Razorpay</div>
            </div>
            <div id="codSection" class="hidden" style="margin-top:20px;">
                <div class="cod-box" style="background: #e8f5e9; border: 1px dashed var(--primary-color); padding: 20px; border-radius: 12px; text-align: center;">
                    <h3 style="margin:0 0 10px 0; color:var(--primary-dark);">üíµ Cash on Delivery</h3>
                    <p style="font-size:14px; color:#555;">Pay cash when the product arrives.</p>
                </div>
                <button class="buy-btn" style="margin-top:25px; background:#ff6f00;" onclick="completeOrder('COD')">Confirm COD Order</button>
            </div>
        </div>
    </div>
    
    <div class="container hidden" id="myOrdersPage">
        <div class="form-card" style="background:#f8f9fa; border:none; box-shadow:none;">
            <div class="page-title"><h3>üì¶ My Orders</h3><span class="close-page-btn" onclick="goHome()">‚úï</span></div>
            <div id="myOrderList" style="display:flex; flex-direction:column; gap:15px;"><div class="loading-spinner"></div></div>
        </div>
    </div>

    <div class="container hidden" id="adminPage">
        <div class="form-card">
            <div class="page-title"><h3>üë®‚Äçüíº Admin Panel</h3><span class="close-page-btn" onclick="goHome()">‚úï</span></div>
            
            <div style="background: #e0f2f1; padding: 15px; border-radius: 12px; border: 1px solid #008060; margin-bottom: 25px;">
                <h4 style="margin-top:0; color: #008060;">‚ûï Add New Product</h4>
                <input type="text" id="newProdName" placeholder="Product Name (e.g. New Rice)" style="margin-top:5px;">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="newProdPrice" placeholder="Price (‚Çπ)" style="flex:1;">
                    <input type="text" id="newProdRating" placeholder="Rating (e.g. 4.5)" value="4.5" style="flex:1;">
                </div>
                
                <label style="font-size:12px; font-weight:600; margin-top:10px; display:block;">Photo (Gallery Upload)</label>
                <input type="file" id="newProdFile" accept="image/*" onchange="handleImageUpload(this, 'newProdImg', 'prevImgElement')">
                <input type="text" id="newProdImg" placeholder="Or paste Image URL here" style="margin-bottom:5px;">
                
                <div id="imgPreview" style="display:none; text-align:center; margin-bottom:10px;">
                    <img id="prevImgElement" src="" style="height:60px; border-radius:5px; border:1px solid #ccc;">
                </div>

                <textarea id="newProdDesc" rows="2" placeholder="Description (e.g. 1kg Pack fresh)" style="margin-top:0;"></textarea>
                <button class="buy-btn" onclick="addNewProduct()" style="margin-top:10px; background:#008060;">Save to Store</button>
            </div>

            <h4 style="margin-bottom:10px;">Recent Orders</h4>
            <div id="adminOrderList" style="display:flex; flex-direction:column; gap:15px;"><div class="loading-spinner"></div></div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" id="navHomeBtn" onclick="goHome(); highlightNav(this)"><span>üè†</span>Home</div>
        <div class="nav-item" onclick="openCart(); highlightNav(this)"><span class="nav-cart-badge">üõí<span id="cartCountBadge">0</span></span>Cart</div>
        <div class="nav-item" onclick="openMyOrders(); highlightNav(this)"><span>üì¶</span>Orders</div> 
        <div class="nav-item" onclick="openMenu()"><span>üë§</span>Profile</div>
    </div>

    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()">
        <div class="menu-drawer" onclick="event.stopPropagation()">
            <div style="text-align:center; margin-bottom:25px; padding-bottom:20px; border-bottom:1px solid #eee;">
                <div style="font-size:45px; margin-bottom:10px; background:#f5f5f5; width:80px; height:80px; line-height:80px; border-radius:50%; margin-left:auto; margin-right:auto;">üë§</div>
                <strong id="menuUserEmail" style="font-size:16px; color:#333;">user@email.com</strong>
            </div>
            <div id="adminLinkContainer"></div>
            <div class="menu-item" onclick="goHome(); closeMenu();"><span class="menu-icon">üè†</span> Home</div>
            <div class="menu-item" onclick="openMyOrders(); closeMenu();"><span class="menu-icon">üì¶</span> My Orders</div> 
            <div class="menu-item" onclick="alert('üìû Support: 9354996087'); closeMenu();"><span class="menu-icon">üìû</span> Help & Support</div>
            <div class="menu-item" onclick="handleLogout()" style="color:#d32f2f; margin-top:10px;"><span class="menu-icon">üö™</span> Logout</div>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyAMszpcGMoctgFhftWixv6Dl0DRfWBk48Y",
    authDomain: "ubaid-kirana-store.firebaseapp.com",
    projectId: "ubaid-kirana-store",
    storageBucket: "ubaid-kirana-store.appspot.com",
    messagingSenderId: "530041642504",
    appId: "1:530041642504:web:401eaa68daa66431963bbd"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

// *** PERSISTENCE SETTING: KEEPS USER LOGGED IN UNTIL EXPLICIT LOGOUT ***
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const ADMIN_EMAIL = "ubadch89688@gmail.com"; 
const RAZORPAY_KEY_ID = "rzp_live_S46Kk7D49BtxsN"; 
const MERCHANT_NAME = "Ubaid Kirana Store";

let currentUser = null;
let isRegistering = false;
let cart = {}; 
let directPurchaseItem = null; 
let checkoutMode = "";
let tempOrderDetails = {};
let selectedSlot = ""; 
let customerLocation = null; 

// --- MASSIVE PRODUCT LIST (135 Items) ---
let products = [
    { id: 1, name: "Venus Soap", price: 30, img: "https://via.placeholder.com/200?text=Venus+Soap", desc: "Best quality soap.", rating: 4.5, reviews: 10 },
    { id: 2, name: "Lux Soap", price: 35, img: "https://via.placeholder.com/200?text=Lux+Soap", desc: "Fragrant beauty soap.", rating: 4.6, reviews: 20 },
    { id: 3, name: "Number 1 Soap", price: 28, img: "https://via.placeholder.com/200?text=No.1+Soap", desc: "Refreshing soap.", rating: 4.2, reviews: 15 },
    { id: 4, name: "Ghadi Sabun", price: 15, img: "https://via.placeholder.com/200?text=Ghadi+Sabun", desc: "Detergent cake.", rating: 4.3, reviews: 25 },
    { id: 5, name: "Fena Sabun", price: 15, img: "https://via.placeholder.com/200?text=Fena+Sabun", desc: "Cleaning soap.", rating: 4.1, reviews: 12 },
    { id: 6, name: "Aata (‡§Ü‡§ü‡§æ)", price: 40, img: "https://via.placeholder.com/200?text=Aata", desc: "Fresh Wheat Flour (1kg).", rating: 4.8, reviews: 100 },
    { id: 7, name: "Chini (‡§ö‡•Ä‡§®‡•Ä)", price: 45, img: "https://via.placeholder.com/200?text=Chini", desc: "Pure Sugar (1kg).", rating: 4.7, reviews: 80 },
    { id: 8, name: "Tel (‡§§‡•á‡§≤)", price: 150, img: "https://via.placeholder.com/200?text=Oil", desc: "Mustard/Refined Oil (1L).", rating: 4.6, reviews: 50 },
    { id: 9, name: "Besan (‡§¨‡•á‡§∏‡§®)", price: 80, img: "https://via.placeholder.com/200?text=Besan", desc: "Gram Flour (1kg).", rating: 4.5, reviews: 40 },
    { id: 10, name: "Colgate", price: 60, img: "https://via.placeholder.com/200?text=Colgate", desc: "Toothpaste.", rating: 4.9, reviews: 200 },
    { id: 11, name: "Burush (Brush)", price: 20, img: "https://via.placeholder.com/200?text=Brush", desc: "Toothbrush.", rating: 4.2, reviews: 10 },
    { id: 12, name: "Samphoo (Shampoo)", price: 2, img: "https://via.placeholder.com/200?text=Shampoo", desc: "Hair Shampoo Sachet.", rating: 4.5, reviews: 30 },
    { id: 13, name: "Namkeen (‡§®‡§Æ‡§ï‡•Ä‡§®)", price: 10, img: "https://via.placeholder.com/200?text=Namkeen", desc: "Tasty Snack.", rating: 4.4, reviews: 45 },
    { id: 14, name: "Tiger Biscuit", price: 10, img: "https://via.placeholder.com/200?text=Tiger+Biscuit", desc: "Glucose Biscuit.", rating: 4.3, reviews: 20 },
    { id: 15, name: "Gudde (Good Day)", price: 20, img: "https://via.placeholder.com/200?text=Good+Day", desc: "Butter Biscuit.", rating: 4.8, reviews: 60 },
    { id: 16, name: "Marie Biscuit", price: 25, img: "https://via.placeholder.com/200?text=Marie", desc: "Tea time biscuit.", rating: 4.5, reviews: 35 },
    { id: 17, name: "Coconut Biscuit", price: 15, img: "https://via.placeholder.com/200?text=Coconut+Biscuit", desc: "Crunchy coconut.", rating: 4.4, reviews: 15 },
    { id: 18, name: "Puff", price: 5, img: "https://via.placeholder.com/200?text=Puff", desc: "Snack Puff.", rating: 4.2, reviews: 10 },
    { id: 19, name: "CNC", price: 10, img: "https://via.placeholder.com/200?text=CNC", desc: "Sweet and Salty.", rating: 4.3, reviews: 12 },
    { id: 20, name: "Twenty - Twenty", price: 10, img: "https://via.placeholder.com/200?text=20-20", desc: "Butter Cookies.", rating: 4.5, reviews: 25 },
    { id: 21, name: "Parle G", price: 5, img: "https://via.placeholder.com/200?text=Parle+G", desc: "Original Glucose.", rating: 4.9, reviews: 150 },
    { id: 22, name: "Papee (Rusk)", price: 30, img: "https://via.placeholder.com/200?text=Rusk", desc: "Crispy Rusk.", rating: 4.4, reviews: 40 },
    { id: 23, name: "TaTa Namak", price: 28, img: "namak.jpeg.webp", desc: "Desh Ka Namak.", rating: 4.8, reviews: 90 },
    { id: 24, name: "Nirma Namak", price: 20, img: "https://via.placeholder.com/200?text=Nirma+Namak", desc: "Iodised Salt.", rating: 4.3, reviews: 30 },
    { id: 25, name: "Sarso Amla Hair Oil", price: 45, img: "https://via.placeholder.com/200?text=Sarso+Amla", desc: "Hair Oil.", rating: 4.4, reviews: 20 },
    { id: 26, name: "Nihar Shanti Amla", price: 40, img: "https://via.placeholder.com/200?text=Nihar+Shanti", desc: "Hair Oil.", rating: 4.5, reviews: 25 },
    { id: 27, name: "Amla hair Oil", price: 35, img: "https://via.placeholder.com/200?text=Amla+Oil", desc: "Pure Amla Oil.", rating: 4.3, reviews: 15 },
    { id: 28, name: "Haldi (‡§π‡§≤‡•ç‡§¶‡•Ä)", price: 200, img: "https://via.placeholder.com/200?text=Haldi", desc: "Turmeric Powder (1kg).", rating: 4.6, reviews: 50 },
    { id: 29, name: "Dhaniya mirch", price: 200, img: "https://via.placeholder.com/200?text=Dhaniya", desc: "Spices mix.", rating: 4.5, reviews: 40 },
    { id: 30, name: "Kali Mirch", price: 50, img: "https://via.placeholder.com/200?text=Kali+Mirch", desc: "Black Pepper (100g).", rating: 4.7, reviews: 30 },
    { id: 31, name: "Long (Laung)", price: 60, img: "https://via.placeholder.com/200?text=Laung", desc: "Cloves (50g).", rating: 4.6, reviews: 25 },
    { id: 32, name: "Badi elaichi", price: 80, img: "https://via.placeholder.com/200?text=Badi+Elaichi", desc: "Black Cardamom.", rating: 4.5, reviews: 20 },
    { id: 33, name: "Choti elaichi", price: 100, img: "https://via.placeholder.com/200?text=Choti+Elaichi", desc: "Green Cardamom.", rating: 4.8, reviews: 35 },
    { id: 34, name: "Tez Path (Patta)", price: 10, img: "https://via.placeholder.com/200?text=Tez+Patta", desc: "Bay Leaf.", rating: 4.3, reviews: 15 },
    { id: 35, name: "Jaiphal Javitri", price: 50, img: "https://via.placeholder.com/200?text=Jaiphal", desc: "Spices.", rating: 4.4, reviews: 10 },
    { id: 36, name: "Lifebuoy Soap", price: 28, img: "https://via.placeholder.com/200?text=Lifebuoy", desc: "Germ Protection.", rating: 4.5, reviews: 60 },
    { id: 37, name: "Cinthol Soap", price: 35, img: "https://via.placeholder.com/200?text=Cinthol", desc: "Lime Fresh.", rating: 4.4, reviews: 40 },
    { id: 38, name: "Margo Soap", price: 30, img: "https://via.placeholder.com/200?text=Margo", desc: "Neem Soap.", rating: 4.3, reviews: 25 },
    { id: 39, name: "Santoor Soap", price: 32, img: "https://via.placeholder.com/200?text=Santoor", desc: "Sandalwood Soap.", rating: 4.6, reviews: 55 },
    { id: 40, name: "Savlon Soap", price: 30, img: "https://via.placeholder.com/200?text=Savlon", desc: "Antiseptic Soap.", rating: 4.5, reviews: 30 },
    { id: 41, name: "Handwash", price: 60, img: "https://via.placeholder.com/200?text=Handwash", desc: "Liquid Handwash.", rating: 4.7, reviews: 45 },
    { id: 42, name: "Chana dal", price: 90, img: "https://via.placeholder.com/200?text=Chana+Dal", desc: "1kg Pack.", rating: 4.5, reviews: 30 },
    { id: 43, name: "Masur dal", price: 100, img: "https://via.placeholder.com/200?text=Masur+Dal", desc: "Red Lentils (1kg).", rating: 4.6, reviews: 35 },
    { id: 44, name: "Aradh dal (Urad)", price: 110, img: "https://via.placeholder.com/200?text=Urad+Dal", desc: "Black Gram (1kg).", rating: 4.4, reviews: 25 },
    { id: 45, name: "Kali Masur", price: 95, img: "https://via.placeholder.com/200?text=Kali+Masur", desc: "Whole Lentils.", rating: 4.3, reviews: 20 },
    { id: 46, name: "Lal malka", price: 90, img: "https://via.placeholder.com/200?text=Lal+Malka", desc: "Red Lentils Split.", rating: 4.5, reviews: 22 },
    { id: 47, name: "Dhuli Masoor", price: 100, img: "https://via.placeholder.com/200?text=Dhuli+Masoor", desc: "Washed Lentils.", rating: 4.6, reviews: 28 },
    { id: 48, name: "Kali Urad", price: 110, img: "https://via.placeholder.com/200?text=Kali+Urad", desc: "Black Gram Whole.", rating: 4.4, reviews: 18 },
    { id: 49, name: "Urad Dhuli", price: 120, img: "https://via.placeholder.com/200?text=Urad+Dhuli", desc: "White Lentils.", rating: 4.7, reviews: 32 },
    { id: 50, name: "Mung dal", price: 110, img: "https://via.placeholder.com/200?text=Mung+Dal", desc: "Yellow Split.", rating: 4.8, reviews: 40 },
    { id: 51, name: "Mung dhova", price: 115, img: "https://via.placeholder.com/200?text=Mung+Dhova", desc: "Washed Moong.", rating: 4.6, reviews: 25 },
    { id: 52, name: "Kala chana", price: 80, img: "https://via.placeholder.com/200?text=Kala+Chana", desc: "Black Chickpeas.", rating: 4.5, reviews: 50 },
    { id: 53, name: "Safed chana", price: 120, img: "https://via.placeholder.com/200?text=Safed+Chana", desc: "Kabuli Chana.", rating: 4.7, reviews: 60 },
    { id: 54, name: "Soyabean", price: 110, img: "https://via.placeholder.com/200?text=Soyabean", desc: "Soya Chunks.", rating: 4.4, reviews: 35 },
    { id: 55, name: "Macroni", price: 40, img: "https://via.placeholder.com/200?text=Macroni", desc: "Pasta.", rating: 4.3, reviews: 40 },
    { id: 56, name: "Pasta", price: 45, img: "https://via.placeholder.com/200?text=Pasta", desc: "Italian style.", rating: 4.4, reviews: 38 },
    { id: 57, name: "Java (Seviyan)", price: 30, img: "https://via.placeholder.com/200?text=Seviyan", desc: "Vermicelli.", rating: 4.5, reviews: 30 },
    { id: 58, name: "Bhuna Java", price: 35, img: "https://via.placeholder.com/200?text=Bhuna+Java", desc: "Roasted Vermicelli.", rating: 4.6, reviews: 25 },
    { id: 59, name: "R. Sarso oil", price: 160, img: "https://via.placeholder.com/200?text=Sarso+Oil", desc: "Mustard Oil (1L).", rating: 4.7, reviews: 55 },
    { id: 60, name: "Bharat oil", price: 150, img: "https://via.placeholder.com/200?text=Bharat+Oil", desc: "Refined Oil.", rating: 4.5, reviews: 40 },
    { id: 61, name: "Badshah oil", price: 155, img: "https://via.placeholder.com/200?text=Badshah+Oil", desc: "Mustard Oil.", rating: 4.4, reviews: 30 },
    { id: 62, name: "Parivar atta", price: 350, img: "https://via.placeholder.com/200?text=Parivar+Atta", desc: "10kg Bag.", rating: 4.6, reviews: 45 },
    { id: 63, name: "Sainik atta", price: 340, img: "https://via.placeholder.com/200?text=Sainik+Atta", desc: "10kg Bag.", rating: 4.5, reviews: 35 },
    { id: 64, name: "Rasoi atta", price: 330, img: "https://via.placeholder.com/200?text=Rasoi+Atta", desc: "10kg Bag.", rating: 4.3, reviews: 20 },
    { id: 65, name: "White atta", price: 30, img: "https://via.placeholder.com/200?text=White+Atta", desc: "Maida (1kg).", rating: 4.2, reviews: 15 },
    { id: 66, name: "Meal atta", price: 35, img: "https://via.placeholder.com/200?text=Meal+Atta", desc: "Whole Wheat.", rating: 4.4, reviews: 25 },
    { id: 67, name: "Chakki atta", price: 40, img: "https://via.placeholder.com/200?text=Chakki+Atta", desc: "Fresh Ground.", rating: 4.8, reviews: 60 },
    { id: 68, name: "Agarbatti", price: 10, img: "https://via.placeholder.com/200?text=Agarbatti", desc: "Incense Sticks.", rating: 4.5, reviews: 50 },
    { id: 69, name: "Rajdhani besan", price: 90, img: "https://via.placeholder.com/200?text=Rajdhani+Besan", desc: "Premium Besan.", rating: 4.6, reviews: 30 },
    { id: 70, name: "Pan besan", price: 80, img: "https://via.placeholder.com/200?text=Pan+Besan", desc: "Besan Pack.", rating: 4.3, reviews: 20 },
    { id: 71, name: "Paras Ghee", price: 500, img: "https://via.placeholder.com/200?text=Paras+Ghee", desc: "Desi Ghee (1L).", rating: 4.8, reviews: 40 },
    { id: 72, name: "Preet Gold Ghee", price: 480, img: "https://via.placeholder.com/200?text=Preet+Ghee", desc: "Desi Ghee (1L).", rating: 4.7, reviews: 35 },
    { id: 73, name: "Anik Ghee", price: 520, img: "https://via.placeholder.com/200?text=Anik+Ghee", desc: "Pure Ghee.", rating: 4.9, reviews: 45 },
    { id: 74, name: "Surf Excel", price: 140, img: "619HRPW3elL._SX522_.jpg", desc: "Detergent Powder.", rating: 4.8, reviews: 100 },
    { id: 75, name: "Nirma Surf", price: 80, img: "https://via.placeholder.com/200?text=Nirma+Surf", desc: "Washing Powder.", rating: 4.3, reviews: 50 },
    { id: 76, name: "Wheel Surf", price: 70, img: "https://via.placeholder.com/200?text=Wheel+Surf", desc: "Active Clean.", rating: 4.2, reviews: 60 },
    { id: 77, name: "Ghadi Surf", price: 65, img: "https://via.placeholder.com/200?text=Ghadi+Surf", desc: "Detergent.", rating: 4.4, reviews: 70 },
    { id: 78, name: "Tide Surf", price: 110, img: "https://via.placeholder.com/200?text=Tide+Surf", desc: "White & Bright.", rating: 4.7, reviews: 80 },
    { id: 79, name: "Try Surf", price: 50, img: "https://via.placeholder.com/200?text=Try+Surf", desc: "Economical.", rating: 4.0, reviews: 15 },
    { id: 80, name: "TaTa Premium Chai", price: 120, img: "https://via.placeholder.com/200?text=Tata+Tea", desc: "Tea leaves (250g).", rating: 4.8, reviews: 90 },
    { id: 81, name: "TaTa Agni Chai", price: 90, img: "https://via.placeholder.com/200?text=Tata+Agni", desc: "Strong Tea.", rating: 4.5, reviews: 60 },
    { id: 82, name: "TaTa Elaichi Chai", price: 130, img: "https://via.placeholder.com/200?text=Elaichi+Tea", desc: "Cardamom Tea.", rating: 4.7, reviews: 40 },
    { id: 83, name: "Rahul Namkeen", price: 10, img: "https://via.placeholder.com/200?text=Namkeen", desc: "Local snack.", rating: 4.2, reviews: 20 },
    { id: 84, name: "Jindal Namkeen", price: 10, img: "https://via.placeholder.com/200?text=Namkeen", desc: "Tasty snack.", rating: 4.3, reviews: 15 },
    { id: 85, name: "Panchratan Namkeen", price: 20, img: "https://via.placeholder.com/200?text=Panchratan", desc: "Mix Namkeen.", rating: 4.5, reviews: 30 },
    { id: 86, name: "Kaju Mixture", price: 30, img: "https://via.placeholder.com/200?text=Kaju+Mix", desc: "Cashew Mix.", rating: 4.6, reviews: 25 },
    { id: 87, name: "Heena Mehndi", price: 15, img: "https://via.placeholder.com/200?text=Mehndi", desc: "Hair Henna.", rating: 4.4, reviews: 10 },
    { id: 88, name: "Silver gold Keep", price: 10, img: "https://via.placeholder.com/200?text=Keep", desc: "Mehndi Cone.", rating: 4.5, reviews: 20 },
    { id: 89, name: "Heeng Dibbe", price: 20, img: "https://via.placeholder.com/200?text=Heeng", desc: "Asafoetida.", rating: 4.6, reviews: 30 },
    { id: 90, name: "Bulb", price: 100, img: "https://via.placeholder.com/200?text=Bulb", desc: "LED Bulb.", rating: 4.5, reviews: 15 },
    { id: 91, name: "Harpic", price: 90, img: "https://via.placeholder.com/200?text=Harpic", desc: "Toilet Cleaner.", rating: 4.8, reviews: 50 },
    { id: 92, name: "Tomato Sauce", price: 110, img: "https://via.placeholder.com/200?text=Sauce", desc: "Ketchup.", rating: 4.6, reviews: 40 },
    { id: 93, name: "Clinic Plus", price: 2, img: "https://via.placeholder.com/200?text=Clinic+Plus", desc: "Shampoo Pouch.", rating: 4.7, reviews: 60 },
    { id: 94, name: "Head & Shoulders", price: 5, img: "https://via.placeholder.com/200?text=H%26S", desc: "Anti-dandruff.", rating: 4.6, reviews: 50 },
    { id: 95, name: "Vatika Shampoo", price: 3, img: "https://via.placeholder.com/200?text=Vatika", desc: "Herbal Shampoo.", rating: 4.4, reviews: 30 },
    { id: 96, name: "Dove Shampoo", price: 5, img: "https://via.placeholder.com/200?text=Dove", desc: "Smooth hair.", rating: 4.8, reviews: 55 },
    { id: 97, name: "Niraf Soap", price: 20, img: "https://via.placeholder.com/200?text=Soap", desc: "Bath Soap.", rating: 4.2, reviews: 10 },
    { id: 98, name: "Boondi", price: 50, img: "https://via.placeholder.com/200?text=Boondi", desc: "Raita Boondi.", rating: 4.5, reviews: 25 },
    { id: 99, name: "Lal Dabur Manjan", price: 40, img: "https://via.placeholder.com/200?text=Lal+Manjan", desc: "Tooth Powder.", rating: 4.4, reviews: 20 },
    { id: 100, name: "Lal Dabur Paste", price: 50, img: "https://via.placeholder.com/200?text=Lal+Paste", desc: "Toothpaste.", rating: 4.5, reviews: 30 },
    { id: 101, name: "White Colgate", price: 55, img: "https://via.placeholder.com/200?text=Colgate", desc: "Strong Teeth.", rating: 4.7, reviews: 40 },
    { id: 102, name: "Refined Bharat", price: 140, img: "https://via.placeholder.com/200?text=Refined", desc: "Cooking Oil.", rating: 4.4, reviews: 25 },
    { id: 103, name: "Refined Fortune", price: 160, img: "https://via.placeholder.com/200?text=Fortune", desc: "Soyabean Oil.", rating: 4.8, reviews: 60 },
    { id: 104, name: "Kaju Biscuit", price: 20, img: "https://via.placeholder.com/200?text=Kaju+Biscuit", desc: "Cookies.", rating: 4.5, reviews: 20 },
    { id: 105, name: "Maggi", price: 14, img: "maggi.jpg", desc: "2-Minute Noodles.", rating: 4.9, reviews: 200 },
    { id: 106, name: "Yippee Maggi", price: 12, img: "https://via.placeholder.com/200?text=Yippee", desc: "Instant Noodles.", rating: 4.6, reviews: 80 },
    { id: 107, name: "Mario Maggi", price: 10, img: "https://via.placeholder.com/200?text=Mario", desc: "Noodles.", rating: 4.2, reviews: 15 },
    { id: 108, name: "Comfort", price: 5, img: "https://via.placeholder.com/200?text=Comfort", desc: "Fabric Conditioner.", rating: 4.7, reviews: 40 },
    { id: 109, name: "Dalia", price: 40, img: "https://via.placeholder.com/200?text=Dalia", desc: "Wheat Porridge.", rating: 4.5, reviews: 30 },
    { id: 110, name: "Chat Masala", price: 30, img: "https://via.placeholder.com/200?text=Chat+Masala", desc: "Spices.", rating: 4.6, reviews: 35 },
    { id: 111, name: "Sabji Masala", price: 25, img: "https://via.placeholder.com/200?text=Sabji+Masala", desc: "Cooking Spices.", rating: 4.5, reviews: 40 },
    { id: 112, name: "Rajma", price: 120, img: "https://via.placeholder.com/200?text=Rajma", desc: "Red Kidney Beans.", rating: 4.7, reviews: 50 },
    { id: 113, name: "Bhuna Chana", price: 80, img: "https://via.placeholder.com/200?text=Bhuna+Chana", desc: "Roasted Gram.", rating: 4.6, reviews: 30 },
    { id: 114, name: "Mithi Kheel", price: 60, img: "https://via.placeholder.com/200?text=Kheel", desc: "Sweet Puffed Rice.", rating: 4.3, reviews: 10 },
    { id: 115, name: "Gold Chawal", price: 60, img: "https://via.placeholder.com/200?text=Rice", desc: "Rice.", rating: 4.5, reviews: 25 },
    { id: 116, name: "Double Hathi", price: 70, img: "https://via.placeholder.com/200?text=Rice", desc: "Rice Premium.", rating: 4.6, reviews: 30 },
    { id: 117, name: "Pona Chawal", price: 50, img: "https://via.placeholder.com/200?text=Rice", desc: "Broken Rice.", rating: 4.3, reviews: 20 },
    { id: 118, name: "Double Chabi", price: 80, img: "https://via.placeholder.com/200?text=Rice", desc: "Basmati Rice.", rating: 4.7, reviews: 40 },
    { id: 119, name: "Rasan Chawal", price: 30, img: "https://via.placeholder.com/200?text=Rice", desc: "Daily Rice.", rating: 4.1, reviews: 15 },
    { id: 120, name: "KRB Chawal", price: 65, img: "https://via.placeholder.com/200?text=Rice", desc: "Rice.", rating: 4.4, reviews: 20 },
    { id: 121, name: "Noor Jahan", price: 90, img: "https://via.placeholder.com/200?text=Noor+Jahan", desc: "Basmati Rice.", rating: 4.8, reviews: 50 },
    { id: 122, name: "Double Full", price: 85, img: "https://via.placeholder.com/200?text=Rice", desc: "Long Grain Rice.", rating: 4.6, reviews: 35 },
    { id: 123, name: "Chappi Chawal", price: 40, img: "https://via.placeholder.com/200?text=Rice", desc: "Rice.", rating: 4.2, reviews: 18 },
    { id: 124, name: "Kachha Pona", price: 45, img: "https://via.placeholder.com/200?text=Rice", desc: "Raw Rice.", rating: 4.3, reviews: 22 },
    { id: 125, name: "Bura", price: 50, img: "https://via.placeholder.com/200?text=Bura", desc: "Powdered Sugar.", rating: 4.5, reviews: 30 },
    { id: 126, name: "Aachar", price: 60, img: "https://via.placeholder.com/200?text=Aachar", desc: "Mango/Mix Pickle.", rating: 4.6, reviews: 40 },
    { id: 127, name: "Kaju", price: 800, img: "https://via.placeholder.com/200?text=Kaju", desc: "Cashews (1kg).", rating: 4.9, reviews: 60 },
    { id: 128, name: "Badam", price: 700, img: "https://via.placeholder.com/200?text=Badam", desc: "Almonds (1kg).", rating: 4.9, reviews: 65 },
    { id: 129, name: "Kismis", price: 300, img: "https://via.placeholder.com/200?text=Kismis", desc: "Raisins (1kg).", rating: 4.7, reviews: 40 },
    { id: 130, name: "Magaj", price: 400, img: "https://via.placeholder.com/200?text=Magaj", desc: "Melon Seeds.", rating: 4.5, reviews: 20 },
    { id: 131, name: "Chironji", price: 900, img: "https://via.placeholder.com/200?text=Chironji", desc: "Dry Fruit.", rating: 4.6, reviews: 15 },
    { id: 132, name: "Gola (Coconut)", price: 200, img: "https://via.placeholder.com/200?text=Coconut", desc: "Dry Coconut.", rating: 4.5, reviews: 30 },
    { id: 133, name: "Makhana", price: 800, img: "https://via.placeholder.com/200?text=Makhana", desc: "Fox Nuts.", rating: 4.8, reviews: 50 },
    { id: 134, name: "Kani", price: 500, img: "https://via.placeholder.com/200?text=Kani", desc: "Dry Fruit Pieces.", rating: 4.4, reviews: 10 },
    { id: 135, name: "Gondh", price: 400, img: "https://via.placeholder.com/200?text=Gondh", desc: "Edible Gum.", rating: 4.5, reviews: 20 }
];

// --- AUTH LOGIC ---
auth.onAuthStateChanged(user => {
    if (user) {
        currentUser = user;
        if (user.emailVerified) {
            document.getElementById("authPage").style.display = "none";
            document.getElementById("verifyPage").classList.add("hidden");
            document.getElementById("appContainer").classList.remove("hidden");
            
            // LOAD CUSTOM PRODUCTS FROM DB, THEN RENDER
            loadCustomProducts().then(() => {
                displayProducts();
            });

            loadUserCart();
            setupMenu();
            updateCartDisplay();
            loadCustomerOrders();
            loadUserProfile(); 
        } else {
            document.getElementById("authPage").style.display = "none";
            document.getElementById("verifyPage").classList.remove("hidden");
            document.getElementById("userEmailDisplay").innerText = user.email;
        }
    } else {
        currentUser = null;
        cart = {};
        document.getElementById("authPage").style.display = "flex";
        document.getElementById("appContainer").classList.add("hidden");
        document.getElementById("verifyPage").classList.add("hidden");
    }
});

let userProfileData = {};

function loadUserProfile(){
    if(!currentUser) return;
    db.collection("users").doc(currentUser.email).get().then(doc => {
        if(doc.exists) userProfileData = doc.data();
    });
}
function loadUserCart() {
    const savedCart = localStorage.getItem('cart_' + currentUser.email);
    cart = savedCart ? JSON.parse(savedCart) : {};
}
function saveUserCart() {
    if(currentUser) localStorage.setItem('cart_' + currentUser.email, JSON.stringify(cart));
}
function toggleAuthMode() {
    isRegistering = !isRegistering;
    const btn = document.getElementById("mainAuthBtn");
    const toggle = document.getElementById("toggleText");
    document.getElementById("authError").innerText = "";
    if (isRegistering) {
        btn.innerText = "Create Account";
        toggle.innerHTML = `Already have an account? <b onclick="toggleAuthMode()" style="color:var(--primary-color);cursor:pointer;">Login</b>`;
    } else {
        btn.innerText = "Login Securely";
        toggle.innerHTML = `New here? <b onclick="toggleAuthMode()" style="color:var(--primary-color);cursor:pointer;">Create Account</b>`;
    }
}
function handleLogin() {
    const email = document.getElementById("authEmail").value;
    const pass = document.getElementById("authPass").value;
    if(!email || !pass) return document.getElementById("authError").innerText = "Please fill all fields";
    if (isRegistering) {
        auth.createUserWithEmailAndPassword(email, pass)
        .then((creds) => creds.user.sendEmailVerification().then(() => alert("Verification link sent!")))
        .catch(err => document.getElementById("authError").innerText = err.message);
    } else {
        auth.signInWithEmailAndPassword(email, pass).catch(err => document.getElementById("authError").innerText = "Incorrect Email or Password");
    }
}
function resetPassword() {
    const email = document.getElementById("authEmail").value;
    if(!email) return alert("Please enter your email address first!");
    auth.sendPasswordResetEmail(email)
    .then(() => alert("Password reset link sent to your email!"))
    .catch(error => alert(error.message));
}
function checkVerification() {
    if(currentUser) currentUser.reload().then(() => { if(currentUser.emailVerified) location.reload(); else alert("Email not verified yet!"); });
}
function handleLogout() {
    cart = {}; updateCartDisplay();
    auth.signOut().then(() => location.reload());
}
function setupMenu() {
    document.getElementById("menuUserEmail").innerText = currentUser.email;
    if (currentUser.email === ADMIN_EMAIL) {
        document.getElementById("adminLinkContainer").innerHTML = 
        `<div class="menu-item" onclick="openAdmin(); closeMenu();"><span class="menu-icon">üîê</span> Admin Panel</div>`;
    } else {
        document.getElementById("adminLinkContainer").innerHTML = "";
    }
}
function openMenu() { document.getElementById("menuOverlay").classList.add("menu-open"); }
function closeMenu() { document.getElementById("menuOverlay").classList.remove("menu-open"); }
function highlightNav(el) {
    document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
    el.classList.add("active");
}

// --- DYNAMIC PRODUCT LOADING (UPDATED FOR MERGING) ---
async function loadCustomProducts() {
    try {
        const snapshot = await db.collection("products").get();
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const data = doc.data();
                // Check if this ID already exists in the local 'products' array
                const existingIndex = products.findIndex(p => p.id === data.id);
                if (existingIndex !== -1) {
                    // Update existing hardcoded product with DB data
                    products[existingIndex] = data;
                } else {
                    // Add new product to top
                    products.unshift(data);
                }
            });
        }
    } catch (e) {
        console.log("Error loading custom products: ", e);
    }
}

// --- STORE LOGIC & PRODUCTS ---
function displayProducts(){
    const grid=document.getElementById("productGrid");
    grid.innerHTML=products.map(p => {
        const cartItem = cart[p.id];
        
        let adminBtn = "";
        if(currentUser && currentUser.email === ADMIN_EMAIL) {
            adminBtn = `<button class="admin-edit-btn" onclick="openEditModal(${p.id}, event)">‚úèÔ∏è Edit</button>`;
        }

        return `
        <div class="product-item">
            ${adminBtn}
            <div style="position:relative">
                <img src="${p.img}" class="product-img" loading="lazy" onclick="openProductDetails(${p.id})" onerror="this.src='https://via.placeholder.com/200?text=Product'">
            </div>
            <div class="product-details">
                <b>${p.name}</b>
                <div class="rating-row">
                    <div class="rating-badge">${p.rating} ‚òÖ</div>
                    <span class="rating-count">(${p.reviews})</span>
                    <div class="f-assured" style="margin-left:auto; display:flex; align-items:center;"><img src="u_fire_logo.jpg" alt="U" onerror="this.style.display='none'" style="height:14px;"><span class="f-assured-text" style="color:#2874f0; font-size:10px; font-weight:700; font-style:italic;">Assured</span></div>
                </div>
                <div class="product-desc-text">${p.desc}</div> <div class="price-tag">‚Çπ${p.price}</div>
            </div>
            <div class="btn-group">
                ${cartItem ? 
                `<div class="qty-btn-group"><span onclick="updateQty(${p.id}, -1)">‚àí</span><span class="qty-val">${cartItem.qty}</span><span onclick="updateQty(${p.id}, 1)">+</span></div>` : 
                `<button class="add-btn" onclick="updateQty(${p.id}, 1)">ADD TO CART</button>`}
                <button class="buy-btn" onclick="buyNow(${p.id})">BUY NOW</button>
            </div>
        </div>`;
    }).join("");
}

// --- IMAGE UPLOAD LOGIC (NEW) ---
function handleImageUpload(inputElement, urlInputElementId, previewElementId) {
    const file = inputElement.files[0];
    if(!file) return;
    
    // UI Feedback
    document.getElementById(urlInputElementId).value = "Processing image...";
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            // Resize to max 300px width to keep database small
            const MAX_WIDTH = 300;
            const scale = MAX_WIDTH / img.width;
            canvas.width = MAX_WIDTH;
            canvas.height = img.height * scale;
            
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            // Convert to efficient JPEG
            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
            
            document.getElementById(urlInputElementId).value = dataUrl;
            document.getElementById(previewElementId).src = dataUrl;
            document.getElementById(previewElementId).parentNode.style.display = "block";
        };
    };
    reader.readAsDataURL(file);
}

// --- EDIT MODAL LOGIC ---
function openEditModal(id, event) {
    if(event) event.stopPropagation(); // Prevent opening product details
    const p = products.find(x => x.id === id);
    if(!p) return;

    document.getElementById("editProdId").value = p.id;
    document.getElementById("editProdName").value = p.name;
    document.getElementById("editProdPrice").value = p.price;
    document.getElementById("editProdImg").value = p.img;
    document.getElementById("editProdDesc").value = p.desc;
    document.getElementById("editImgPreview").src = p.img;
    
    document.getElementById("editModal").style.display = "block";
}

function closeEditModal() {
    document.getElementById("editModal").style.display = "none";
}

function previewEditImage() {
    document.getElementById("editImgPreview").src = document.getElementById("editProdImg").value;
}

function saveEditProduct() {
    const id = Number(document.getElementById("editProdId").value);
    const name = document.getElementById("editProdName").value;
    const price = document.getElementById("editProdPrice").value;
    const img = document.getElementById("editProdImg").value;
    const desc = document.getElementById("editProdDesc").value;
    
    // Find original to keep rating/reviews
    const original = products.find(x => x.id === id);
    const updatedData = {
        id: id,
        name: name,
        price: Number(price),
        img: img,
        desc: desc,
        rating: original ? original.rating : 4.5,
        reviews: original ? original.reviews : 0
    };

    // Save to Firestore (using ID as document name to overwrite)
    db.collection("products").doc(String(id)).set(updatedData, { merge: true })
    .then(() => {
        alert("Product Updated Successfully!");
        // Update local array
        const idx = products.findIndex(x => x.id === id);
        if(idx !== -1) products[idx] = updatedData;
        
        displayProducts();
        closeEditModal();
    })
    .catch(e => alert("Error updating: " + e.message));
}


// --- NEW PRODUCT DETAILS LOGIC ---
function openProductDetails(id) {
    const p = products.find(x => x.id === id);
    if(!p) return;
    
    const cartItem = cart[p.id];
    
    // Logic for Related Products (Exclude current item, take 4 others)
    let relatedHtml = products.filter(x => x.id !== id).slice(0, 4).map(r => `
        <div class="rel-card" onclick="openProductDetails(${r.id})">
            <img src="${r.img}" class="rel-img" loading="lazy" onerror="this.src='https://via.placeholder.com/100?text=Product'">
            <div class="rel-name" style="font-size:12px; font-weight:600;">${r.name}</div>
            <div class="rel-price" style="font-size:13px; font-weight:700; color:var(--primary-color);">‚Çπ${r.price}</div>
        </div>
    `).join("");

    // Inject HTML into the detail content div
    document.getElementById("productDetailContent").innerHTML = `
        <div class="pd-header">
            <span class="pd-back" onclick="closeProductDetails()">‚Üê</span>
            <span class="pd-title-top">Product Details</span>
        </div>
        
        <div class="pd-scroll-content">
            <div class="pd-image-box">
                <img src="${p.img}" class="pd-image" onerror="this.src='https://via.placeholder.com/400?text=Product'">
            </div>

            <div class="pd-main-title">${p.name}</div>
            
            <div class="rating-row">
                <div class="rating-badge" style="font-size:13px; padding:4px 8px;">${p.rating} ‚òÖ</div>
                <span class="rating-count" style="font-size:13px;">(${p.reviews} Ratings)</span>
                <div class="f-assured"><img src="u_fire_logo.jpg" style="height:16px" onerror="this.style.display='none'"><span class="f-assured-text" style="color:#2874f0; font-weight:700; font-style:italic;">Assured</span></div>
            </div>

            <div class="pd-price">‚Çπ${p.price}</div>

            <div class="pd-desc-box">
                <div class="pd-label">Description</div>
                <div class="pd-text">${p.desc}</div>
            </div>

            <div class="related-section">
                <div class="related-header" style="font-weight:700; margin-bottom:15px; color:#333;">You might also like</div>
                <div class="related-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    ${relatedHtml}
                </div>
            </div>

            <div class="pd-badges">
                <span class="badge-pill b-assured" style="background:#e3f2fd; color:#1565c0;">üõ°Ô∏è Ubaid Assured</span>
                <span class="badge-pill b-cod" style="background:#fff3e0; color:#ef6c00;">üöö COD Available</span>
                <span class="badge-pill b-fresh" style="background:#e8f5e9; color:#2e7d32;">üçÉ Fresh Product</span>
            </div>
        </div>

        <div class="pd-footer-actions">
            ${cartItem ? 
                `<div class="qty-btn-group" style="flex:1; height:45px;"><span onclick="updateQty(${p.id}, -1)">‚àí</span><span class="qty-val">${cartItem.qty}</span><span onclick="updateQty(${p.id}, 1)">+</span></div>` : 
                `<button class="add-btn" style="flex:1; padding:12px 0;" onclick="updateQty(${p.id}, 1)">ADD TO CART</button>`
            }
            <button class="buy-btn" style="flex:1" onclick="buyNow(${p.id})">BUY NOW</button>
        </div>
    `;

    // Show the page
    document.getElementById("productDetailsPage").classList.add("active");
}

function closeProductDetails() {
    document.getElementById("productDetailsPage").classList.remove("active");
    // Refresh main grid in case quantities changed
    displayProducts();
    updateCartDisplay();
}

function updateQtyFromDetails(id) {
    // If user clicks "IN CART" button inside details page, take them to cart
    closeProductDetails();
    openCart();
}

// -- EXISTING CART LOGIC ---
function updateQty(id, change) {
    const product = products.find(p => p.id === id);
    if (!cart[id]) cart[id] = { ...product, qty: 0 };
    cart[id].qty += change;
    if (cart[id].qty <= 0) delete cart[id];
    saveUserCart(); 
    updateCartDisplay(); 
    displayProducts();
    
    // If the details page is open, refresh it to show updated button state
    if(document.getElementById("productDetailsPage").classList.contains("active")){
        openProductDetails(id);
    }
}

function updateCartDisplay(){
    let totalItems = 0, subTotal = 0, html = "";
    Object.values(cart).forEach(item => {
        totalItems += item.qty; 
        subTotal += (item.price * item.qty);
        html += `
        <div class="cart-row">
            <img src="${item.img}" class="cart-item-img" onerror="this.src='https://via.placeholder.com/60?text=Item'">
            <div style="flex:1;">
                <div style="font-size:15px; font-weight:600; color:#333;">${item.name}</div>
                <div style="font-size:13px; color:#888;">Unit Price: ‚Çπ${item.price}</div>
                <div class="cart-controls-mini" style="display:inline-flex;">
                    <div class="cart-btn-mini" onclick="updateQty(${item.id}, -1)" style="padding:4px 12px; background:#f5f5f5; cursor:pointer; color:var(--primary-color);">‚àí</div>
                    <div class="cart-qty-mini" style="padding:4px 12px; font-weight:600; border-left:1px solid #eee; border-right:1px solid #eee;">${item.qty}</div>
                    <div class="cart-btn-mini" onclick="updateQty(${item.id}, 1)" style="padding:4px 12px; background:#f5f5f5; cursor:pointer; color:var(--primary-color);">+</div>
                </div>
            </div>
            <div style="font-weight:700; font-size:16px; margin-left:10px;">‚Çπ${item.price * item.qty}</div>
        </div>`;
    });
    let deliveryCharge = (subTotal > 0 && subTotal < 199) ? 20 : 0;
    let deliveryText = (deliveryCharge > 0) ? "‚Çπ20" : "<span style='color:green'>Free</span>";
    let finalTotal = subTotal + deliveryCharge;
    
    if(subTotal > 0) html += `<div style="display:flex;justify-content:space-between;align-items:center; padding:15px 0; border-bottom:1px solid #eee; color:#666;"><div style="font-size:14px;">Delivery Charge</div><b>${deliveryText}</b></div>`;

    document.getElementById("cartCountBadge").innerText = totalItems;
    document.getElementById("cartCountInner").innerText = totalItems;
    document.getElementById("cartItems").innerHTML = html || "<div style='text-align:center; padding:40px 20px; color:#999'><div style='font-size:40px; margin-bottom:10px;'>üõí</div>Your Cart is Empty</div>";
    document.getElementById("cartTotal").innerText = "Total: ‚Çπ" + finalTotal;
}

function buyNow(id){
    let item = cart[id];
    let qty = item ? item.qty : 1;
    directPurchaseItem = [{ ...products.find(p => p.id === id), qty: qty }];
    closeProductDetails(); // Close details if open
    goToAddress('direct');
}

function hideAll(){
    ["shopPage","cartPage","addressPage","slotPage","paymentPage","myOrdersPage","adminPage"].forEach(id=>document.getElementById(id).classList.add("hidden"));
    // Also ensure product details is closed
    document.getElementById("productDetailsPage").classList.remove("active");
}
function goHome(){ 
    hideAll(); document.getElementById("shopPage").classList.remove("hidden"); highlightNav(document.getElementById("navHomeBtn")); displayProducts();
}
function openCart(){ 
    hideAll(); document.getElementById("cartPage").classList.remove("hidden"); updateCartDisplay(); 
}

function goToAddress(mode, isRefresh = false){ 
    checkoutMode = mode;
    let items = (mode === 'cart') ? Object.values(cart) : directPurchaseItem;
    if(!items || !items.length) return alert("Cart is empty!");
    
    let itemTotal = items.reduce((s,i)=>s+(i.price*i.qty),0);
    let deliveryCharge = (itemTotal < 199) ? 20 : 0;
    let finalTotal = itemTotal + deliveryCharge;
    
    let itemsHtml = items.map(i => `
        <div class="checkout-item" style="display:flex; align-items:center;">
            <img src="${i.img}" class="checkout-img" onerror="this.src='https://via.placeholder.com/50?text=Item'" style="width:50px; height:50px; object-fit:contain; border:1px solid #eee; border-radius:8px; margin-right:10px;">
            <div class="checkout-info" style="flex:1;">
                <div style="font-size:14px; font-weight:600;">${i.name}</div>
                <div style="font-size:12px; color:#666;">‚Çπ${i.price}</div>
                <div class="checkout-controls" style="display:flex; border:1px solid #ddd; width:fit-content; border-radius:6px; margin-top:5px; overflow:hidden;">
                    <div class="checkout-btn" onclick="updateQtyCheckout(${i.id}, -1)" style="padding:2px 10px; background:#f9f9f9; cursor:pointer;">‚àí</div>
                    <div class="checkout-qty" style="padding:2px 10px; font-size:13px; font-weight:600; border-left:1px solid #ddd; border-right:1px solid #ddd;">${i.qty}</div>
                    <div class="checkout-btn" onclick="updateQtyCheckout(${i.id}, 1)" style="padding:2px 10px; background:#f9f9f9; cursor:pointer;">+</div>
                </div>
            </div>
            <div style="font-weight:700; font-size:15px; margin-left:10px;">‚Çπ${i.price * i.qty}</div>
        </div>
    `).join("");

    document.getElementById("checkoutItemsList").innerHTML = `<h4 style="margin:0 0 15px 0; color:#444;">üõí Your Basket</h4>${itemsHtml}`;
    let deliveryText = (deliveryCharge === 0) ? `<span style="color:green; font-weight:bold;">FREE</span>` : `<span style="color:red; font-weight:bold;">‚Çπ20</span>`;
    let freeDelNote = (itemTotal < 199) ? `<div style="font-size:11px; color:#d32f2f; margin-top:5px;">‚ö†Ô∏è Add items worth ‚Çπ${199 - itemTotal} more for FREE Delivery!</div>` : `<div style="font-size:11px; color:green; margin-top:5px;">‚úÖ Free Delivery Applied</div>`;

    document.getElementById("checkoutBillDetails").innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:15px; margin-bottom:8px;"><span>Item Total</span> <b>‚Çπ${itemTotal}</b></div>
        <div style="display:flex; justify-content:space-between; font-size:16px; margin-bottom:12px;"><span>Delivery Charge</span> ${deliveryText}</div>
        <hr style="border-top:1px dashed #bbb; margin:10px 0;">
        <div style="display:flex; justify-content:space-between; font-size:22px; color:var(--primary-color); margin-top:8px;"><strong>TOTAL</strong> <strong>‚Çπ${finalTotal}</strong></div>
        <div style="text-align:center; margin-top:8px;">${freeDelNote}</div>
    `;
    
    if(!isRefresh) {
        hideAll(); 
        document.getElementById("addressPage").classList.remove("hidden"); 
        if(userProfileData) {
            if(userProfileData.name && !document.getElementById("custName").value) document.getElementById("custName").value = userProfileData.name;
            if(userProfileData.phone && !document.getElementById("custPhone").value) document.getElementById("custPhone").value = userProfileData.phone;
            if(userProfileData.address && !document.getElementById("custAddress").value) document.getElementById("custAddress").value = userProfileData.address;
        }
    }
}
function updateQtyCheckout(id, change) {
    if (checkoutMode === 'cart') {
        updateQty(id, change);
        if (Object.keys(cart).length === 0) goHome(); else goToAddress('cart', true);
    } else {
        if(directPurchaseItem && directPurchaseItem.length > 0 && directPurchaseItem[0].id === id) {
            directPurchaseItem[0].qty += change;
            if(directPurchaseItem[0].qty <= 0) goHome(); else goToAddress('direct', true);
        }
    }
}
function goBackToAddress(){ hideAll(); document.getElementById("addressPage").classList.remove("hidden"); }

// --- FAST LOCATION OPTIMIZED ---
function detectLocation() {
    const btn = document.getElementById("locBtn");
    const addressBox = document.getElementById("custAddress");
    if (!navigator.geolocation) return alert("Geolocation not supported");

    btn.innerHTML = "<span>üõ∞Ô∏è</span> Locating...";
    
    const options = {
        enableHighAccuracy: true, 
        timeout: 5000, 
        maximumAge: 0
    };

    navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude; 
        const lon = position.coords.longitude;
        customerLocation = { lat: lat, lng: lon }; 
        
        // Immediate Feedback
        btn.innerHTML = "<span>‚úÖ</span> Found!";
        addressBox.placeholder = "Fetching address...";
        
        try {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
            const response = await fetch(url); 
            const data = await response.json();
            if(data && data.display_name) { 
                addressBox.value = data.display_name; 
            } else {
                addressBox.value = `Lat: ${lat}, Lon: ${lon}`;
            }
        } catch (error) { 
            addressBox.value = `Lat: ${lat}, Lon: ${lon}`; 
        }
    }, (error) => { 
        alert("Location error: " + error.message); 
        btn.innerHTML = "<span>üìç</span> Retry GPS"; 
    }, options);
}

// --- SLOT ---
function goToSlotPage() {
    const name = document.getElementById("custName").value;
    const phone = document.getElementById("custPhone").value;
    const address = document.getElementById("custAddress").value;
    const saveAddr = document.getElementById("saveAddrCheckbox").checked; 
    if(!name || !phone || !address) return alert("Please fill Name, Phone, and Address first!");

    if(saveAddr) {
        db.collection("users").doc(currentUser.email).set({ name: name, phone: phone, address: address }, { merge: true }).then(() => { userProfileData = { name, phone, address }; });
    }
    tempOrderDetails = { name, phone, address };
    const items = (checkoutMode === 'cart') ? Object.values(cart) : directPurchaseItem;
    const itemTotal = items.reduce((s,i)=>s+(i.price*i.qty),0);
    const deliveryCharge = (itemTotal < 199) ? 20 : 0;
    tempOrderDetails.itemTotal = itemTotal; tempOrderDetails.deliveryCharge = deliveryCharge; tempOrderDetails.total = itemTotal + deliveryCharge; tempOrderDetails.items = items;

    generateSlots(); 
    hideAll();
    document.getElementById("slotPage").classList.remove("hidden");
}
function generateSlots() {
    const container = document.getElementById("slotsContainer"); container.innerHTML = ""; selectedSlot = ""; 
    const now = new Date(); const currentHour = now.getHours(); 
    const slots = [{ label: "10:00 AM - 12:00 PM", cutoff: 9 }, { label: "01:00 PM - 03:00 PM", cutoff: 12 }, { label: "05:00 PM - 07:00 PM", cutoff: 17 }];
    let availableSlots = []; let isTomorrow = false;
    if (currentHour >= 17) { isTomorrow = true; availableSlots = slots; } else { availableSlots = slots.filter(s => currentHour < s.cutoff); if(availableSlots.length === 0) { isTomorrow = true; availableSlots = slots; } }
    const dayText = isTomorrow ? "TOMORROW" : "TODAY";
    availableSlots.forEach(slot => {
        const div = document.createElement("div"); div.className = "time-slot-card"; div.innerHTML = `<span class="slot-time">${slot.label}</span> <span class="slot-day">${dayText}</span>`;
        div.onclick = () => { document.querySelectorAll(".time-slot-card").forEach(e => e.classList.remove("selected-slot")); div.classList.add("selected-slot"); selectedSlot = `${dayText} (${slot.label})`; };
        container.appendChild(div);
    });
}

// --- PAYMENT ---
function goToPayment(){
    if(!selectedSlot) return alert("Please select a delivery time slot!");
    tempOrderDetails.deliverySlot = selectedSlot; hideAll(); document.getElementById("paymentPage").classList.remove("hidden");
    document.getElementById("paymentTotalDisplay").innerText = "‚Çπ" + tempOrderDetails.total; togglePaymentMode('online');
}
function togglePaymentMode(mode) {
    const onlineSec = document.getElementById("onlineSection"); const codSec = document.getElementById("codSection");
    const tabOnline = document.getElementById("tabOnline"); const tabCOD = document.getElementById("tabCOD");
    if(mode === 'online') { onlineSec.classList.remove("hidden"); codSec.classList.add("hidden"); tabOnline.classList.add("active-tab"); tabCOD.classList.remove("active-tab"); } else { onlineSec.classList.add("hidden"); codSec.classList.remove("hidden"); tabOnline.classList.remove("active-tab"); tabCOD.classList.add("active-tab"); }
}
function startRazorpayPayment() {
    if (!tempOrderDetails.total) return alert("Invalid Amount");
    var options = {
        "key": RAZORPAY_KEY_ID, "amount": tempOrderDetails.total * 100, "currency": "INR", "name": MERCHANT_NAME, "description": "Order Payment", "image": "https://cdn-icons-png.flaticon.com/512/3081/3081559.png", 
        "handler": function (response) { completeOrder('ONLINE', response.razorpay_payment_id); },
        "prefill": { "name": tempOrderDetails.name, "email": currentUser.email, "contact": tempOrderDetails.phone },
        "notes": { "address": tempOrderDetails.address, "slot": tempOrderDetails.deliverySlot }, "theme": { "color": "#008060" }
    };
    var rzp1 = new Razorpay(options); rzp1.on('payment.failed', function (response){ alert("Payment Failed: " + response.error.description); }); rzp1.open();
}
function completeOrder(method, txnId){
    const payStatus = (method === 'COD') ? "Pending (COD)" : "PAID (Online)";
    const orderStatus = (method === 'COD') ? "Pending" : "Confirmed"; 
    const finalMethod = (method === 'ONLINE') ? `Online (ID: ${txnId || 'NA'})` : method;
    db.collection("orders").add({
        userEmail: currentUser.email, name: tempOrderDetails.name, phone: tempOrderDetails.phone, address: tempOrderDetails.address, gpsLocation: customerLocation || null, deliverySlot: tempOrderDetails.deliverySlot, items: tempOrderDetails.items, itemTotal: tempOrderDetails.itemTotal, deliveryCharge: tempOrderDetails.deliveryCharge, total: tempOrderDetails.total, orderType: checkoutMode, paymentMethod: finalMethod, paymentStatus: payStatus, status: orderStatus, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
        if(checkoutMode === 'cart'){ cart={}; saveUserCart(); updateCartDisplay(); }
        document.getElementById("paymentPage").classList.add("hidden"); document.getElementById("successOverlay").classList.remove("hidden"); customerLocation = null;
    }).catch(e => alert(e.message));
}
function closeSuccess(){ document.getElementById("successOverlay").classList.add("hidden"); goHome(); }

// --- ADMIN & ORDERS ---
function openAdmin(){ if(currentUser.email !== ADMIN_EMAIL) return alert("Access Denied!"); hideAll(); document.getElementById("adminPage").classList.remove("hidden"); loadAdminOrders(); }
function openMyOrders(){ hideAll(); document.getElementById("myOrdersPage").classList.remove("hidden"); }
function loadAdminOrders(){
  const list = document.getElementById("adminOrderList"); list.innerHTML = "<div class='loading-spinner'></div>";
  db.collection("orders").limit(50).onSnapshot(snapshot=>{
    let orders = []; snapshot.forEach(doc => { orders.push({id: doc.id, ...doc.data()}); });
    orders.sort((a,b) => { let t1 = a.createdAt ? a.createdAt.seconds : 0; let t2 = b.createdAt ? b.createdAt.seconds : 0; return t2 - t1; });
    let html = ""; orders.forEach(o => { html += renderOrderCard(o, true); }); list.innerHTML = html || "<div style='text-align:center; padding:20px'>No orders found.</div>";
  });
}
function loadCustomerOrders(){
    const list = document.getElementById("myOrderList"); if(list.innerHTML.trim() === "") list.innerHTML = "<div class='loading-spinner'></div>";
    db.collection("orders").limit(50).onSnapshot(snapshot => {
        if(snapshot.empty) { list.innerHTML = "<p style='text-align:center'>Database is empty (No orders at all)</p>"; return; }
        let orders = []; let myOrdersCount = 0;
        let html=""; 
        snapshot.forEach(doc => { let data = doc.data(); if(data.userEmail === currentUser.email) { orders.push({id: doc.id, ...data}); myOrdersCount++; } });
        if(myOrdersCount === 0) { list.innerHTML = "<div style='text-align:center; padding:40px; color:#888;'><h3>üì¶</h3>You haven't placed any orders yet.</div>"; return; }
        orders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        orders.forEach(o => { html += renderOrderCard(o, false); }); list.innerHTML = html;
    });
}

// --- ADD NEW PRODUCT FUNCTION ---
function previewImage() {
    const url = document.getElementById("newProdImg").value;
    const prev = document.getElementById("imgPreview");
    if(url) {
        prev.style.display = "block";
        document.getElementById("prevImgElement").src = url;
    } else {
        prev.style.display = "none";
    }
}

function addNewProduct() {
    const name = document.getElementById("newProdName").value;
    const price = document.getElementById("newProdPrice").value;
    const img = document.getElementById("newProdImg").value;
    const desc = document.getElementById("newProdDesc").value;
    const rating = document.getElementById("newProdRating").value || 4.5;
    
    if(!name || !price || !img) {
        return alert("Please fill Name, Price and Image Link");
    }

    const newId = Date.now(); // Unique ID based on time
    
    // Save new product to Firestore
    db.collection("products").doc(String(newId)).set({
        id: newId,
        name: name,
        price: Number(price),
        img: img,
        desc: desc || "Fresh Product",
        rating: Number(rating),
        reviews: 0
    }).then(() => {
        alert("Product Added Successfully!");
        // Clear fields
        document.getElementById("newProdName").value = "";
        document.getElementById("newProdPrice").value = "";
        document.getElementById("newProdImg").value = "";
        document.getElementById("newProdDesc").value = "";
        document.getElementById("imgPreview").style.display = "none";
        // Reload products
        loadCustomProducts().then(() => displayProducts());
    }).catch(e => alert("Error adding product: " + e.message));
}

function renderOrderCard(o, isAdmin) {
    let color = '#ff9800'; if(o.status === 'Confirmed') color = '#2196f3'; if(o.status === 'Delivered') color = '#4caf50';
    let pm = o.paymentMethod || ''; if(pm.includes('COD')) color = '#795548'; 
    let dateStr = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
    let itemsHtml = ''; if (o.items && Array.isArray(o.items)) { itemsHtml = o.items.map(i => `<div style="font-size:13px; display:flex; justify-content:space-between; margin-bottom:4px;"><span>${i.name} x${i.qty}</span><span>‚Çπ${i.price * i.qty}</span></div>`).join(""); }
    let deliveryRow = ""; if(o.deliveryCharge && o.deliveryCharge > 0) { deliveryRow = `<div style="font-size:13px; display:flex; justify-content:space-between; color:#d32f2f; margin-top:5px;"><span>Delivery Charge</span><span>‚Çπ${o.deliveryCharge}</span></div>`; }
    let mapLink = ""; if(isAdmin && o.gpsLocation && o.gpsLocation.lat && o.gpsLocation.lng) { const googleMapsUrl = `http://maps.google.com/maps?q=${o.gpsLocation.lat},${o.gpsLocation.lng}`; mapLink = `<a href="${googleMapsUrl}" target="_blank" style="display:inline-block; margin-top:8px; color:#fff; background:#4285F4; padding:6px 12px; border-radius:6px; text-decoration:none; font-size:12px; font-weight:600;">üó∫Ô∏è Open in Google Maps</a>`; }
    let adminControls = "";
    if (isAdmin) {
        let nextStatus = "", btnLabel = "", btnBg = "";
        if(o.status === "Pending") { nextStatus = "Confirmed"; btnLabel = "‚úÖ Accept Order"; btnBg = "#2e7d32"; } else if(o.status === "Confirmed") { nextStatus = "Delivered"; btnLabel = "üöö Mark Delivered"; btnBg = "#1976d2"; } else { nextStatus = "Pending"; btnLabel = "‚Ü© Reset"; btnBg = "#555"; }
        adminControls = `<div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:13px; font-weight:600;">üìû <a href="tel:${o.phone}" style="color:blue;text-decoration:none;">${o.phone}</a></span><button onclick="updateStatus('${o.id}','${nextStatus}')" style="background:${btnBg}; color:#fff; border:none; border-radius:8px; padding:8px 16px; cursor:pointer; font-size:13px; font-weight:bold;">${btnLabel}</button></div>`;
    }
    return `<div class="order-card" style="border-left:5px solid ${color}; background:#fff; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow:0 4px 12px rgba(0,0,0,0.05);"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>${o.name || 'User'}</strong> <span class="status-pill" style="background:${color}; padding:4px 10px; border-radius:20px; font-size:11px; font-weight:bold; color:#fff; text-transform:uppercase;">${o.status}</span></div><div style="font-size:12px; color:#666; margin-bottom:8px;">${dateStr} ‚Ä¢ ‚Çπ${o.total} ‚Ä¢ ${o.paymentMethod}</div><div style="font-size:14px; font-weight:bold; color:var(--primary-color); margin: 6px 0;">‚è∞ ${o.deliverySlot || 'Standard Delivery'}</div><div style="background:#f9f9f9; padding:10px; border-radius:8px; margin-top:8px;"><div style="font-size:12px; font-weight:bold; color:#333; margin-bottom:5px;">Items:</div>${itemsHtml}${deliveryRow}</div><div style="font-size:12px; color:#555; margin-top:10px; line-height:1.4;">üìç ${o.address} <br>${mapLink}</div>${adminControls}</div>`;
}
function updateStatus(id, newStatus){ if(!confirm("Change status to " + newStatus + "?")) return; db.collection("orders").doc(id).update({ status: newStatus }).catch((error) => { alert("Error updating status: " + error.message); }); }
function filter(){ let q=document.getElementById("searchInput").value.toLowerCase(); document.querySelectorAll(".product-item").forEach(p=>p.style.display=p.innerText.toLowerCase().includes(q)?"flex":"none"); }
function resendVerificationLink() { currentUser.sendEmailVerification().then(()=>alert("Sent!")); }
</script>
</body>
</html>